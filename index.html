<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tour Intelligence Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1000;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            letter-spacing: 2px;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .api-status {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.3);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.85em;
        }
        
        .api-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
            background: #4CAF50;
            box-shadow: 0 0 8px #4CAF50;
        }
        
        .container {
            display: flex;
            height: calc(100vh - 140px);
        }
        
        .controls {
            width: 360px;
            background: rgba(45, 45, 45, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid rgba(102, 126, 234, 0.3);
        }
        
        .control-group {
            margin-bottom: 20px;
            background: rgba(51, 51, 51, 0.5);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .control-group h3 {
            margin: 0 0 15px 0;
            color: #667eea;
            font-size: 1.1em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
            font-weight: 600;
        }
        
        .tour-story-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .tour-story-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s;
        }
        
        .tour-story-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid rgba(102, 126, 234, 0.5);
            border-radius: 8px;
            background: rgba(26, 26, 46, 0.8);
            color: white;
            font-size: 14px;
        }
        
        .btn-load-data {
            background: #00d4ff;
            color: #1a1a2e;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            margin-bottom: 10px;
            transition: all 0.2s;
        }
        
        .btn-load-data:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.4);
        }
        
        #map {
            flex: 1;
        }
        
        .artist-info {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2) 0%, rgba(102, 126, 234, 0.2) 100%);
            padding: 15px;
            border-radius: 12px;
            margin-top: 10px;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }
        
        .artist-stat {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .artist-stat:last-child {
            border-bottom: none;
        }
        
        .artist-stat-label {
            color: #bbb;
            font-size: 0.9em;
        }
        
        .artist-stat-value {
            color: #00d4ff;
            font-weight: 600;
        }
        
        .venue-rec {
            background: rgba(0, 212, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #00d4ff;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .venue-rec:hover {
            background: rgba(0, 212, 255, 0.2);
            transform: translateX(5px);
        }
        
        .venue-rec-name {
            font-weight: 600;
            color: #00d4ff;
            margin-bottom: 5px;
        }
        
        .venue-rec-location {
            font-size: 0.9em;
            color: #bbb;
            margin-bottom: 5px;
        }
        
        .venue-rec-score {
            font-size: 0.85em;
            color: #4CAF50;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(102, 126, 234, 0.3);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-message {
            margin-top: 20px;
            font-size: 1.2em;
            color: #667eea;
        }
        
        .stats {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }
        
        .stats h3 {
            margin-top: 0;
            color: #667eea;
            font-size: 1.2em;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
        }
        
        .stat-label {
            color: #bbb;
        }
        
        .stat-value {
            color: #00d4ff;
            font-weight: 700;
            font-size: 1.1em;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(51, 51, 51, 0.6);
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 8px;
        }
        
        .checkbox-item input[type="checkbox"] {
            accent-color: #667eea;
            width: 18px;
            height: 18px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="api-status">
            <span class="api-indicator"></span>
            <span>APIs Ready</span>
        </div>
        <h1>TOUR INTELLIGENCE PLATFORM</h1>
        <p>AI-Powered Tour Planning & Market Analysis for Any Artist</p>
    </div>
    
    <div class="container">
        <div class="controls">
            <div class="tour-story-section">
                <h3 style="color: white; margin-bottom: 15px; font-size: 1.3em;">Tour Story</h3>
                <button id="tourStoryBtn" class="tour-story-btn">Play Tour Story</button>
            </div>
            
            <div class="control-group">
                <h3>Artist Intelligence</h3>
                <input type="text" id="artistNameInput" placeholder="Enter artist name...">
                <button id="loadArtistData" class="btn-load-data">Load Artist Data</button>
                <div id="artistInfo" class="artist-info" style="display: none;">
                    <div class="artist-stat">
                        <span class="artist-stat-label">Artist:</span>
                        <span class="artist-stat-value" id="artistName">--</span>
                    </div>
                    <div class="artist-stat">
                        <span class="artist-stat-label">Popularity:</span>
                        <span class="artist-stat-value" id="artistPopularity">--</span>
                    </div>
                    <div class="artist-stat">
                        <span class="artist-stat-label">Followers:</span>
                        <span class="artist-stat-value" id="artistFollowers">--</span>
                    </div>
                    <div class="artist-stat">
                        <span class="artist-stat-label">Genres:</span>
                        <span class="artist-stat-value" id="artistGenres">--</span>
                    </div>
                </div>
            </div>
            
            <div class="control-group">
                <h3>Smart Venue Finder</h3>
                <div style="margin-bottom: 10px; font-size: 0.9em; color: #bbb;">
                    Analyzes your route to find venues in gap areas
                </div>
                <label style="display: block; margin-bottom: 10px; color: #bbb; font-size: 0.9em;">
                    Min Capacity:
                </label>
                <input type="number" id="minCapacity" value="200" placeholder="200">
                <label class="checkbox-item">
                    <input type="checkbox" id="criticalOnly" checked>
                    <span>Critical Gaps Only (400+ mi)</span>
                </label>
                <button id="loadVenues" class="btn-load-data">Analyze & Find Venues</button>
                <div id="venueList" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
            
            <div class="control-group">
                <h3>Comparable Artists</h3>
                <button id="loadComparable" class="btn-load-data">Load Comparable Tours</button>
                <div id="comparableList"></div>
            </div>
            
            <div class="control-group">
                <h3>Map Layers</h3>
                <label class="checkbox-item">
                    <input type="checkbox" id="showConfirmed" checked>
                    <span>Confirmed Shows</span>
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" id="showRouting" checked>
                    <span>Routing Lines</span>
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" id="showGaps" checked>
                    <span>Gap Analysis</span>
                </label>
            </div>
            
            <div class="stats">
                <h3>Tour Statistics</h3>
                <div class="stat-item">
                    <span class="stat-label">Total Shows:</span>
                    <span class="stat-value" id="totalShows">29</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">States Covered:</span>
                    <span class="stat-value" id="statesCovered">10</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Miles:</span>
                    <span class="stat-value" id="totalMiles">~8,500</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Critical Gaps:</span>
                    <span class="stat-value" id="criticalGaps">5</span>
                </div>
            </div>
        </div>
        
        <div id="map"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        const API_CONFIG = {
            spotify: {
                clientId: '76567c4611d34304a92d2c3e15a2a274',
                clientSecret: '33308b82ed99475bb2dac3dba9e35910'
            },
            ticketmaster: {
                clientKey: 'iKHzhXpwka1uZlupvraVK5GpAWHxHG2g',
                clientSecret: '65Zz6HsLbaZywxlG'
            },
            setlistfm: {
                apiKey: '4QL-DnHQgXNQGtZ-xd5B9WvoqhP3ageHeL-FS'
            }
        };

        const tourData = [
            { date: '2025-10-16', venue: 'Blueroom', city: 'Bellingham, WA', lat: 48.7519, lng: -122.4787 },
            { date: '2025-10-17', venue: 'Elks Ballroom/Chameleon', city: 'Tacoma, WA', lat: 47.2529, lng: -122.4443 },
            { date: '2025-10-24', venue: 'Chameleon/Elk\'s Ballroom', city: 'Spokane, WA', lat: 47.6587, lng: -117.4260 },
            { date: '2025-10-25', venue: 'Good Bones Kitchen', city: 'Arcata, CA', lat: 40.8665, lng: -124.0828 },
            { date: '2025-10-26', venue: 'Good Bones Kitchen', city: 'Arcata, CA', lat: 40.8665, lng: -124.0828 },
            { date: '2025-10-30', venue: 'Little Saint', city: 'Healdsburg, CA', lat: 38.6104, lng: -122.8695 },
            { date: '2025-11-01', venue: 'Richards Goat', city: 'Arcata, CA', lat: 40.8665, lng: -124.0828 },
            { date: '2025-11-02', venue: 'Heirloom', city: 'Salinas, CA', lat: 36.6777, lng: -121.6555 },
            { date: '2025-11-02', venue: 'Showdown PDX', city: 'Portland, OR', lat: 45.5152, lng: -122.6784 },
            { date: '2025-11-04', venue: 'Elks Temple', city: 'Tacoma, WA', lat: 47.2529, lng: -122.4443 },
            { date: '2025-11-05', venue: 'Elks Temple', city: 'Tacoma, WA', lat: 47.2529, lng: -122.4443 },
            { date: '2025-11-06', venue: 'Freakout Fest', city: 'Seattle, WA', lat: 47.6062, lng: -122.3321 },
            { date: '2025-11-07', venue: 'Freakout Fest', city: 'Seattle, WA', lat: 47.6062, lng: -122.3321 },
            { date: '2025-11-08', venue: 'Freakout Fest', city: 'Seattle, WA', lat: 47.6062, lng: -122.3321 },
            { date: '2025-11-09', venue: 'Showdown PDX', city: 'Portland, OR', lat: 45.5152, lng: -122.6784 },
            { date: '2025-11-14', venue: 'Offbeat', city: 'Reno, NV', lat: 39.5296, lng: -119.8138 },
            { date: '2025-11-15', venue: 'Freight & Salvage', city: 'Berkeley, CA', lat: 37.8715, lng: -122.2730 },
            { date: '2025-11-16', venue: 'Zebulon', city: 'Los Angeles, CA', lat: 34.0522, lng: -118.2437 },
            { date: '2025-11-18', venue: 'CCA', city: 'Flagstaff, AZ', lat: 35.1983, lng: -111.6513 },
            { date: '2025-11-19', venue: 'Lensic 360', city: 'Santa Fe, NM', lat: 35.6870, lng: -105.9378 },
            { date: '2025-11-20', venue: 'Hi Dive', city: 'Denver, CO', lat: 39.7392, lng: -104.9903 },
            { date: '2025-11-21', venue: 'Atrium', city: 'Denver, CO', lat: 39.7392, lng: -104.9903 },
            { date: '2025-11-22', venue: 'Goosetown Tavern', city: 'Denver, CO', lat: 39.7392, lng: -104.9903 },
            { date: '2025-11-23', venue: 'Atrium', city: 'Fort Collins, CO', lat: 40.5853, lng: -105.0844 },
            { date: '2025-11-25', venue: 'farout', city: 'Austin, TX', lat: 30.2672, lng: -97.7431 },
            { date: '2025-11-28', venue: 'State Room', city: 'Salt Lake City, UT', lat: 40.7608, lng: -111.8910 },
            { date: '2025-11-29', venue: 'duck club', city: 'Boise, ID', lat: 43.6150, lng: -116.2023 },
            { date: '2025-11-30', venue: 'duck club', city: 'Boise, ID', lat: 43.6150, lng: -116.2023 },
            { date: '2025-12-02', venue: 'lucky dime', city: 'Everett, WA', lat: 47.9790, lng: -122.2021 }
        ];

        let map, confirmedLayer, routingLayer, gapsLayer;
        let artistData = null;
        let comparableArtists = [];
        let venueRecommendations = [];

        document.addEventListener('DOMContentLoaded', initializeMap);

        function initializeMap() {
            if (typeof L === 'undefined') {
                alert('Map library failed to load');
                return;
            }
            
            map = L.map('map').setView([40.0, -98.0], 4);
            
            // Use OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            confirmedLayer = L.layerGroup().addTo(map);
            routingLayer = L.layerGroup().addTo(map);
            gapsLayer = L.layerGroup().addTo(map);

            loadMapContent();
            setupEventHandlers();
        }

        function loadMapContent() {
            addConfirmedShows();
            addRoutingLines();
            addGapAnalysis();
            updateStats();
        }

        function addConfirmedShows() {
            confirmedLayer.clearLayers();
            tourData.forEach(function(show, index) {
                const icon = L.divIcon({
                    html: '<div style="background: #00d4ff; border: 3px solid white; border-radius: 50%; width: 20px; height: 20px; box-shadow: 0 0 10px rgba(0,212,255,0.5);"></div>',
                    className: '',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                
                const marker = L.marker([show.lat, show.lng], { icon: icon }).addTo(confirmedLayer);
                
                const popupHtml = '<div><strong>' + show.venue + '</strong><br>' + 
                    show.city + '<br>' + 
                    '<small>' + show.date + '</small></div>';
                
                marker.bindPopup(popupHtml);
            });
        }

        function addRoutingLines() {
            routingLayer.clearLayers();
            for (let i = 0; i < tourData.length - 1; i++) {
                const current = tourData[i];
                const next = tourData[i + 1];
                L.polyline([
                    [current.lat, current.lng],
                    [next.lat, next.lng]
                ], {
                    color: '#00d4ff',
                    weight: 3,
                    opacity: 0.7,
                    dashArray: '8, 12'
                }).addTo(routingLayer);
            }
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 3959;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function addGapAnalysis() {
            gapsLayer.clearLayers();
            for (let i = 0; i < tourData.length - 1; i++) {
                const current = tourData[i];
                const next = tourData[i + 1];
                const distance = calculateDistance(current.lat, current.lng, next.lat, next.lng);
                
                let color = '#4CAF50';
                if (distance > 400) {
                    color = '#FF3B30';
                } else if (distance > 250) {
                    color = '#FF9500';
                }
                
                if (distance > 150) {
                    const midLat = (current.lat + next.lat) / 2;
                    const midLng = (current.lng + next.lng) / 2;
                    L.circleMarker([midLat, midLng], {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.8,
                        radius: 12,
                        weight: 3
                    }).addTo(gapsLayer).bindPopup(Math.round(distance) + ' miles gap');
                }
            }
        }

        function updateStats() {
            let totalDistance = 0;
            let criticalGaps = 0;
            
            for (let i = 0; i < tourData.length - 1; i++) {
                const distance = calculateDistance(
                    tourData[i].lat, tourData[i].lng,
                    tourData[i+1].lat, tourData[i+1].lng
                );
                totalDistance += distance;
                if (distance > 400) criticalGaps++;
            }
            
            document.getElementById('totalShows').textContent = tourData.length;
            document.getElementById('totalMiles').textContent = '~' + Math.round(totalDistance).toLocaleString();
            document.getElementById('criticalGaps').textContent = criticalGaps;
            
            const uniqueStates = [...new Set(tourData.map(s => s.city.split(',')[1]))];
            document.getElementById('statesCovered').textContent = uniqueStates.length;
        }

        function showLoading(message) {
            const loader = document.createElement('div');
            loader.className = 'loading-overlay';
            loader.id = 'loader';
            loader.innerHTML = '<div class="loading-spinner"></div><div class="loading-message">' + message + '</div>';
            document.body.appendChild(loader);
        }

        function hideLoading() {
            const loader = document.getElementById('loader');
            if (loader) loader.remove();
        }

        // SPOTIFY
        async function getSpotifyToken() {
            try {
                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': 'Basic ' + btoa(API_CONFIG.spotify.clientId + ':' + API_CONFIG.spotify.clientSecret)
                    },
                    body: 'grant_type=client_credentials'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to get Spotify token. Status: ' + response.status);
                }
                
                const data = await response.json();
                
                if (!data.access_token) {
                    throw new Error('No access token received from Spotify');
                }
                
                return data.access_token;
            } catch (error) {
                console.error('Spotify token error:', error);
                throw error;
            }
        }

        async function searchSpotifyArtist(artistName, token) {
            try {
                const url = 'https://api.spotify.com/v1/search?q=' + encodeURIComponent(artistName) + '&type=artist&limit=1';
                console.log('Searching Spotify for:', artistName);
                
                const response = await fetch(url, { 
                    headers: { 'Authorization': 'Bearer ' + token } 
                });
                
                if (!response.ok) {
                    throw new Error('Spotify search failed. Status: ' + response.status);
                }
                
                const data = await response.json();
                console.log('Spotify response:', data);
                
                if (data.artists && data.artists.items && data.artists.items.length > 0) {
                    return data.artists.items[0];
                }
                return null;
            } catch (error) {
                console.error('Spotify search error:', error);
                throw error;
            }
        }

        async function getRelatedArtists(artistId, token) {
            const response = await fetch(
                'https://api.spotify.com/v1/artists/' + artistId + '/related-artists',
                { headers: { 'Authorization': 'Bearer ' + token } }
            );
            const data = await response.json();
            return data.artists;
        }

        // TICKETMASTER
        async function searchVenues(city, state) {
            const url = 'https://app.ticketmaster.com/discovery/v2/venues?city=' + 
                encodeURIComponent(city) + '&stateCode=' + state + 
                '&apikey=' + API_CONFIG.ticketmaster.clientKey;
            const response = await fetch(url);
            const data = await response.json();
            return data._embedded ? data._embedded.venues : [];
        }

        // SETLIST.FM
        async function getArtistTourHistory(artistName) {
            const url = 'https://api.setlist.fm/rest/1.0/search/setlists?artistName=' + 
                encodeURIComponent(artistName) + '&p=1';
            const response = await fetch(url, {
                headers: {
                    'x-api-key': API_CONFIG.setlistfm.apiKey,
                    'Accept': 'application/json'
                }
            });
            const data = await response.json();
            return data.setlist || [];
        }

        function setupEventHandlers() {
            document.getElementById('loadArtistData').addEventListener('click', loadArtistData);
            document.getElementById('loadVenues').addEventListener('click', loadVenueRecommendations);
            document.getElementById('loadComparable').addEventListener('click', loadComparableData);
            
            document.getElementById('showConfirmed').addEventListener('change', function(e) {
                e.target.checked ? map.addLayer(confirmedLayer) : map.removeLayer(confirmedLayer);
            });
            
            document.getElementById('showRouting').addEventListener('change', function(e) {
                e.target.checked ? map.addLayer(routingLayer) : map.removeLayer(routingLayer);
            });
            
            document.getElementById('showGaps').addEventListener('change', function(e) {
                e.target.checked ? map.addLayer(gapsLayer) : map.removeLayer(gapsLayer);
            });
        }

        async function loadArtistData() {
            const artistName = document.getElementById('artistNameInput').value.trim();
            if (!artistName) {
                alert('Please enter an artist name');
                return;
            }
            
            showLoading('Connecting to Spotify...');
            
            try {
                // Test if API keys work
                const token = await getSpotifyToken();
                console.log('Got token successfully');
                
                showLoading('Searching for ' + artistName + '...');
                artistData = await searchSpotifyArtist(artistName, token);
                
                if (artistData) {
                    document.getElementById('artistInfo').style.display = 'block';
                    document.getElementById('artistName').textContent = artistData.name;
                    document.getElementById('artistPopularity').textContent = artistData.popularity + '/100';
                    document.getElementById('artistFollowers').textContent = artistData.followers.total.toLocaleString();
                    document.getElementById('artistGenres').textContent = artistData.genres.join(', ') || 'Various';
                    
                    comparableArtists = await getRelatedArtists(artistData.id, token);
                    
                    hideLoading();
                    alert('Success!\n\nLoaded: ' + artistData.name + '\nPopularity: ' + artistData.popularity + '/100\nFollowers: ' + artistData.followers.total.toLocaleString() + '\n\nFound ' + comparableArtists.length + ' similar artists!');
                } else {
                    hideLoading();
                    alert('Artist not found on Spotify.\n\nTry:\n- Checking the spelling\n- Using the full artist name\n- Trying a different artist');
                }
            } catch (error) {
                hideLoading();
                console.error('Full error:', error);
                
                // Better error messages
                if (error.message.includes('400') || error.message.includes('401')) {
                    alert('⚠️ Spotify API Authentication Failed\n\nThe Spotify API keys may be incorrect or expired.\n\nThis is a known issue - the keys need to be refreshed.\n\nFor now, the venue finder and map features still work!\n\nError: ' + error.message);
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    alert('⚠️ Network Error\n\nCannot connect to Spotify API.\n\nThis might be a CORS issue when running from GitHub Pages.\n\nThe map and venue finder still work!');
                } else {
                    alert('Error: ' + error.message + '\n\nCheck the browser console for details.');
                }
            }
        }

        async function loadVenueRecommendations() {
            showLoading('Analyzing tour route for gaps...');
            
            try {
                venueRecommendations = [];
                const criticalOnly = document.getElementById('criticalOnly').checked;
                const gaps = [];
                
                for (let i = 0; i < tourData.length - 1; i++) {
                    const current = tourData[i];
                    const next = tourData[i + 1];
                    const distance = calculateDistance(current.lat, current.lng, next.lat, next.lng);
                    
                    let priority = 'optimization';
                    if (distance > 400) {
                        priority = 'critical';
                    } else if (distance > 250) {
                        priority = 'opportunity';
                    }
                    
                    if (criticalOnly && priority !== 'critical') continue;
                    
                    if (distance > 200) {
                        gaps.push({
                            from: current,
                            to: next,
                            distance: distance,
                            priority: priority,
                            midLat: (current.lat + next.lat) / 2,
                            midLng: (current.lng + next.lng) / 2
                        });
                    }
                }
                
                if (gaps.length === 0) {
                    hideLoading();
                    alert('No major gaps found! Try unchecking "Critical Only"');
                    return;
                }
                
                for (let gap of gaps) {
                    const cityInfo = await getCityFromCoordinates(gap.midLat, gap.midLng);
                    
                    if (cityInfo) {
                        const venues = await searchVenues(cityInfo.city, cityInfo.state);
                        
                        venues.slice(0, 3).forEach(function(venue) {
                            const score = calculateVenueScore(venue, gap);
                            venueRecommendations.push({
                                venue: venue,
                                score: score,
                                priority: gap.priority,
                                gap: {
                                    from: gap.from.city,
                                    to: gap.to.city,
                                    distance: Math.round(gap.distance)
                                }
                            });
                        });
                    }
                }
                
                venueRecommendations.sort(function(a, b) { return b.score - a.score; });
                displayVenueRecommendations();
                
                hideLoading();
                alert('Found ' + venueRecommendations.length + ' venue recommendations!');
            } catch (error) {
                hideLoading();
                alert('Error: ' + error.message);
            }
        }

        async function getCityFromCoordinates(lat, lng) {
            try {
                const url = 'https://nominatim.openstreetmap.org/reverse?format=json&lat=' + 
                    lat + '&lon=' + lng + '&zoom=10&addressdetails=1';
                const response = await fetch(url, {
                    headers: { 'User-Agent': 'TourIntelligence/1.0' }
                });
                const data = await response.json();
                
                if (data && data.address) {
                    const city = data.address.city || data.address.town || data.address.village;
                    const state = data.address.state;
                    const stateCode = getStateAbbreviation(state);
                    
                    if (city && stateCode) {
                        return { city: city, state: stateCode };
                    }
                }
            } catch (error) {
                console.error('Geocoding error:', error);
            }
            return null;
        }

        function getStateAbbreviation(stateName) {
            const states = {
                'Alabama': 'AL', 'Alaska': 'AK', 'Arizona': 'AZ', 'Arkansas': 'AR', 'California': 'CA',
                'Colorado': 'CO', 'Connecticut': 'CT', 'Delaware': 'DE', 'Florida': 'FL', 'Georgia': 'GA',
                'Idaho': 'ID', 'Illinois': 'IL', 'Indiana': 'IN', 'Iowa': 'IA', 'Kansas': 'KS',
                'Montana': 'MT', 'Nebraska': 'NE', 'Nevada': 'NV', 'New Mexico': 'NM', 'New York': 'NY',
                'Oregon': 'OR', 'Pennsylvania': 'PA', 'Texas': 'TX', 'Utah': 'UT', 'Washington': 'WA'
            };
            return states[stateName] || stateName;
        }

        function calculateVenueScore(venue, gap) {
            let score = 0;
            
            if (gap.priority === 'critical') score += 30;
            else if (gap.priority === 'opportunity') score += 20;
            else score += 10;
            
            if (venue.upcomingEvents && venue.upcomingEvents._total > 20) {
                score += 20;
            }
            
            score += 30;
            
            return Math.min(score, 100);
        }

        function displayVenueRecommendations() {
            const container = document.getElementById('venueList');
            
            if (venueRecommendations.length === 0) {
                container.innerHTML = '<p style="color: #888; padding: 10px;">No recommendations</p>';
                return;
            }
            
            let html = '';
            venueRecommendations.slice(0, 10).forEach(function(rec) {
                const borderColor = rec.priority === 'critical' ? '#FF3B30' : 
                    rec.priority === 'opportunity' ? '#FF9500' : '#4CAF50';
                
                html += '<div class="venue-rec" style="border-left-color: ' + borderColor + ';" onclick="flyToVenue(' + 
                    rec.venue.location.latitude + ',' + rec.venue.location.longitude + ')">';
                html += '<div class="venue-rec-name">' + rec.venue.name + '</div>';
                html += '<div class="venue-rec-location">' + rec.venue.city.name + ', ' + rec.venue.state.stateCode + '</div>';
                html += '<div class="venue-rec-score">Score: ' + Math.round(rec.score) + '/100 | Gap: ' + 
                    rec.gap.from + ' to ' + rec.gap.to + ' (' + rec.gap.distance + 'mi)</div>';
                html += '</div>';
            });
            
            container.innerHTML = html;
        }

        function flyToVenue(lat, lng) {
            map.flyTo([lat, lng], 12, { duration: 1.5 });
        }

        async function loadComparableData() {
            if (!comparableArtists || comparableArtists.length === 0) {
                alert('Please load artist data first!');
                return;
            }
            
            showLoading('Loading comparable artist tours...');
            
            try {
                const comparableData = [];
                
                for (let i = 0; i < Math.min(5, comparableArtists.length); i++) {
                    const artist = comparableArtists[i];
                    const tourHistory = await getArtistTourHistory(artist.name);
                    
                    if (tourHistory.length > 0) {
                        comparableData.push({
                            artist: artist,
                            showCount: tourHistory.length
                        });
                    }
                }
                
                displayComparableArtists(comparableData);
                
                hideLoading();
                alert('Loaded ' + comparableData.length + ' comparable artists!');
            } catch (error) {
                hideLoading();
                alert('Error: ' + error.message);
            }
        }

        function displayComparableArtists(comparableData) {
            const container = document.getElementById('comparableList');
            
            if (comparableData.length === 0) {
                container.innerHTML = '<p style="color: #888; padding: 10px;">Load artist data first</p>';
                return;
            }
            
            let html = '';
            comparableData.forEach(function(comp, index) {
                const popularity = comp.artist.popularity || 0;
                const followers = comp.artist.followers ? comp.artist.followers.total : 0;
                const followersK = Math.round(followers / 1000);
                
                html += '<div class="checkbox-item">';
                html += '<input type="checkbox" id="comp-' + index + '">';
                html += '<div style="flex: 1;">';
                html += '<div style="font-weight: 600;">' + comp.artist.name + '</div>';
                html += '<div style="font-size: 0.8em; color: #888;">';
                html += 'Popularity: ' + popularity + '/100 | ' + followersK + 'K followers | ' + comp.showCount + ' shows';
                html += '</div>';
                html += '</div>';
                html += '</div>';
            });
            
            container.innerHTML = html;
        }
    </script>
</body>
</html>
